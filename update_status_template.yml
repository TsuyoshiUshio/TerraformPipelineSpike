# Check status and update the current state
parameters:
- name: NewStatus
  type: string
- name: expireDurationDays
  type: number
  default: 9
steps:
- task: AzureCLI@2
  displayName: Update Variable Group variables
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
  inputs:
    azureSubscription: mySubscription
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      # az extension add --name azure-devops
      export AZURE_DEVOPS_EXT_PAT=$(System.AccessToken)

      declare organizationURL=""
      declare project=""
      declare id=""

      function initialize() {
        organizationURL=$(System.CollectionUri)
        project="$(System.TeamProject)"
        id=$(az pipelines variable-group list --org $organizationURL --project "${project}" --group-name "pullrequest.state" | jq -r '.[0] | .id')
      }

      function getNewExpireDate() {
        current=$(date "+%s")
        newExpireDate=$((current + (3600 * 24 * ${{ expireDurationDays }})))
        echo $newExpireDate
      }

      function updateStatus() {
        initialize        
        newExpireDate=`getNewExpireDate`

        az pipelines variable-group variable update --id $id --name "PullRequestNumber" --value "$(System.PullRequest.PullRequestNumber)" --org $organizationURL --project "${project}" 
        az pipelines variable-group variable update --id $id --name "ExpireDate" --value "$(date --date @${newExpireDate} "+%m/%d/%Y %H:%M")" --org $organizationURL --project "${project}" 
        az pipelines variable-group variable update --id $id --name "Status" --value ${{ NewStatus }} --org $organizationURL --project "${project}" 
      }

      updateStatus
